[user]
	email = {{ .git.email }}
	name = {{ .git.name }}

[core]
    autocrlf = input
    pager = delta

[interactive]
	diffFilter = delta --color-only

[delta]
	side-by-side = true

[alias]
	amend-push = !git add -A && git commit --amend --no-edit && git push --force-with-lease
	commit-amend = !git add -A && git commit --amend --no-edit
	
	default-branch = !git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@'
	merge-base-origin = "!/bin/bash -c 'git merge-base \"${1:-HEAD}\" \"origin/$(git default-branch)\"' -- "
	stack = "!/bin/bash -c 'BRANCH=\"${1:-HEAD}\"; MERGE_BASE=\"$(git merge-base-origin \"$BRANCH\")\"; git log --decorate-refs=refs/heads --simplify-by-decoration --pretty=format:\"%(decorate:prefix=,suffix=,tag=,separator=%n)\" \"$MERGE_BASE\"..\"$BRANCH\"' -- "

[rebase]
	updateRefs = true
	autosquash = true

[push]
	autoSetupRemote = true

{{- if .machine.is_work }}

[push]
	pushOption = merge_request.create
	pushOption = merge_request.remove_source_branch
	pushOption = merge_request.squash
	pushOption = merge_request.label=scrum::barend
	pushOption = merge_request.label=Ready for Review
	pushOption = merge_request.assign=trahman

[alias]
	push-stack = "!/bin/bash -c 'BRANCH=\"${1:-HEAD}\"; DEFAULT=$(git default-branch); PREV=\"$DEFAULT\"; MERGE_BASE=$(git merge-base-origin \"$BRANCH\"); while read -r BR || [[ -n \"$BR\" ]]; do git push --force-with-lease -o merge_request.create -o merge_request.remove_source_branch -o merge_request.squash -o merge_request.label=scrum::barend -o \"merge_request.label=Ready for Review\" -o merge_request.assign=trahman -o merge_request.target=\"$PREV\" origin \"$BR\"; PREV=\"$BR\"; done < <(git log --reverse --decorate-refs=refs/heads --simplify-by-decoration --pretty=format:\"%(decorate:prefix=,suffix=,tag=,separator=%n)\" \"$MERGE_BASE\"..\"$BRANCH\")' -- "

# Work-specific Git configuration
{{- if hasKey .git "gitlab_domain" }}
# Git URL rewrites for work GitLab
[url "git@{{ .git.gitlab_domain }}:"]
	insteadOf = https://{{ .git.gitlab_domain }}
{{- end }}

{{- if hasKey .git "token" }}
# Credential helper with personal access token
[credential]
	helper = "!f() { sleep 1; echo \"username=token\"; echo \"password={{ .git.token }}\"; }; f"
{{- end }}
{{- end }}
