#!/bin/bash
# Set Fish shell as the default shell on macOS

{{- if eq .chezmoi.os "darwin" }}

set -e

# Colors for output (matching repository pattern)
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Path to Homebrew fish
FISH_PATH="/opt/homebrew/bin/fish"

# Check if fish is already the default shell
CURRENT_SHELL=$(dscl . -read ~/ UserShell | awk '{print $2}')
if [[ "$CURRENT_SHELL" == "$FISH_PATH" ]]; then
    echo -e "${GREEN}✓ Fish is already the default shell${NC}"
    exit 0
fi

# Check if fish is installed
if [[ ! -x "$FISH_PATH" ]]; then
    echo -e "${YELLOW}⚠️  Fish shell not found at $FISH_PATH${NC}"
    echo "   Install fish with: brew install fish"
    exit 1
fi

echo ""
echo -e "${BLUE}Setting fish as default shell...${NC}"
echo ""

# Check if fish is in /etc/shells
if ! grep -q "^$FISH_PATH$" /etc/shells 2>/dev/null; then
    echo "Adding $FISH_PATH to /etc/shells (requires sudo)..."
    echo "$FISH_PATH" | sudo tee -a /etc/shells > /dev/null
    echo -e "${GREEN}✓ Added fish to /etc/shells${NC}"
fi

# Change default shell
echo "Changing default shell to fish..."
chsh -s "$FISH_PATH"

echo -e "${GREEN}✓ Default shell changed to fish${NC}"
echo ""
echo "Restart your terminal for changes to take effect"
echo ""

{{- else }}
# Non-macOS systems - do nothing
exit 0
{{- end }}
